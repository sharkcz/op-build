From 56209254b27e5062298a7ba368ee4ec705addf74 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Dan=20Hor=C3=A1k?= <dan@danny.cz>
Date: Tue, 17 Dec 2019 23:36:49 +0100
Subject: [PATCH 2/2] platform: let Talos use the LPC observer feature
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Follow the Blackbird example and let Talos use the LPC observer directly
without needing a script in skiroot.

Signed-off-by: Dan Hor√°k <dan@danny.cz>
---
 platforms/astbmc/talos.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/platforms/astbmc/talos.c b/platforms/astbmc/talos.c
index 55a33859..e85e7d02 100644
--- a/platforms/astbmc/talos.c
+++ b/platforms/astbmc/talos.c
@@ -11,6 +11,7 @@
 #include <ipmi.h>
 #include <psi.h>
 #include <npu-regs.h>
+#include <lpc.h>
 
 #include "astbmc.h"
 
@@ -58,6 +59,15 @@ static bool talos_probe(void)
 	return true;
 }
 
+static void talos_exit(void)
+{
+	/* Let the IPL Observer know that we're done */
+	/*lpc_probe_write(OPAL_LPC_IO, 0x81, 0xfe, 1);*/
+	/*lpc_probe_write(OPAL_LPC_IO, 0x82, 0xfe, 1);*/
+
+	astbmc_exit();
+}
+
 DECLARE_PLATFORM(talos) = {
 	.name			= "Talos",
 	.probe			= talos_probe,
@@ -70,7 +80,7 @@ DECLARE_PLATFORM(talos) = {
 	.cec_power_down         = astbmc_ipmi_power_down,
 	.cec_reboot             = astbmc_ipmi_reboot,
 	.elog_commit		= ipmi_elog_commit,
-	.exit			= astbmc_exit,
+	.exit			= talos_exit,
 	.terminate		= ipmi_terminate,
 	.op_display		= op_display_lpc,
 };
-- 
2.21.0

